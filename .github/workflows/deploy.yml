name: Deploy to Oracle Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.OCI_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.OCI_HOST }} >> ~/.ssh/known_hosts
          
          cat > ~/.ssh/config << EOF
          Host oci
            HostName ${{ secrets.OCI_HOST }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ServerAliveInterval 60
            ServerAliveCountMax 10
            StrictHostKeyChecking no
          EOF
      
      - name: Pull Latest Code
        run: |
          ssh oci "cd ~/CoRe_Test && git pull origin main"
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: complaint-management/frontend/package-lock.json
      
      - name: Build Frontend Locally
        run: |
          cd complaint-management/frontend
          npm ci --legacy-peer-deps
          npm run build
      
      - name: Deploy Backend
        run: |
          ssh oci "cd ~/CoRe_Test/complaint-management/backend && npm install --production --prefer-offline --no-audit"
          ssh oci "cd ~/CoRe_Test/complaint-management/backend && pm2 restart corems-backend || pm2 start ecosystem.config.js"
      
      - name: Deploy Frontend Build
        run: |
          ssh oci "mkdir -p /tmp/frontend-build"
          scp -r complaint-management/frontend/build/* oci:/tmp/frontend-build/
          ssh oci "sudo rm -rf /var/www/complaint-management/*"
          ssh oci "sudo cp -r /tmp/frontend-build/* /var/www/complaint-management/"
          ssh oci "sudo chown -R www-data:www-data /var/www/complaint-management"
          ssh oci "rm -rf /tmp/frontend-build"
          ssh oci "sudo systemctl reload nginx"
      
      - name: Verify Deployment
        run: |
          ssh oci "pm2 status"
          ssh oci "curl -s http://localhost:5000/api/categories || echo 'Backend check failed'"
