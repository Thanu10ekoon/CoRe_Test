name: Deploy to Oracle Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.OCI_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.OCI_HOST }} >> ~/.ssh/known_hosts
          
          cat > ~/.ssh/config << EOF
          Host oci
            HostName ${{ secrets.OCI_HOST }}
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ServerAliveInterval 60
            ServerAliveCountMax 10
            StrictHostKeyChecking no
          EOF
      
      - name: Pull Latest Code
        run: |
          ssh oci "cd ~/CoRe_Test && git pull origin main"
      
      - name: Deploy Backend
        run: |
          ssh oci "cd ~/CoRe_Test/complaint-management/backend && npm install --production --prefer-offline --no-audit"
          ssh oci "cd ~/CoRe_Test/complaint-management/backend && pm2 restart corems-backend || pm2 start ecosystem.config.js"
      
      - name: Deploy Frontend
        run: |
          ssh oci "cd ~/CoRe_Test/complaint-management/frontend && npm install --prefer-offline --no-audit"
          ssh oci "cd ~/CoRe_Test/complaint-management/frontend && npm run build"
          ssh oci "sudo rm -rf /var/www/complaint-management/*"
          ssh oci "sudo cp -r ~/CoRe_Test/complaint-management/frontend/build/* /var/www/complaint-management/"
          ssh oci "sudo systemctl reload nginx"
      
      - name: Verify Deployment
        run: |
          ssh oci "pm2 status"
          ssh oci "curl -s http://localhost:5000/api/categories || echo 'Backend check failed'"
